<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Client</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        var socket;
        var currentRoomId;
        
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({email, password}),
                credentials: 'include' // 重要：包含cookie
            })
            .then(response => response.json())
            .then(data => {
                if(data.message === 'Login successful') {
                    // 登录成功后建立Socket连接
                    socket = io.connect('http://192.168.236.26:5000', {
                        withCredentials: true // 重要：携带cookie
                    });
                    
                    setupSocketEvents();
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('chatForm').style.display = 'block';
                    fetchRooms();
                }
            });
        }
        
        function setupSocketEvents() {
            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('error', function(error) {
                console.error('Error:', error.message);
                alert(error.message);
            });

            socket.on('system_message', function(msg) {
                displayMessage(`[系统] ${msg.message}`);
            });

            socket.on('new_message', function(msg) {
                displayMessage(`${msg.nickname}: ${msg.content}`);
            });
        }
        
        function displayMessage(msg) {
            const messageElement = document.createElement('div');
            messageElement.textContent = msg;
            document.getElementById('messages').appendChild(messageElement);
        }
        
        function fetchRooms() {
            fetch('/rooms', {
                method: 'GET',
                credentials: 'include' // 重要：包含cookie
            })
            .then(response => response.json())
            .then(data => {
                const roomsContainer = document.getElementById('roomsContainer');
                roomsContainer.innerHTML = '';
                data.rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.textContent = room.room_name;
                    roomElement.onclick = () => joinRoom(room.id, room.has_password);
                    roomsContainer.appendChild(roomElement);
                });
            });
        }
        
        function joinRoom(roomId, hasPassword) {
            currentRoomId = roomId;
            if (hasPassword) {
                const password = prompt('请输入房间密码:');
                if (password) {
                    socket.emit('join_room', { room_id: roomId, password: password });
                }
            } else {
                socket.emit('join_room', { room_id: roomId });
            }
        }
        
        function sendMessage() {
            const content = document.getElementById('messageInput').value;
            socket.emit('send_message', { 
                room_id: currentRoomId, 
                content: content 
            });
            document.getElementById('messageInput').value = '';
        }
        
        function createRoom() {
            const roomName = document.getElementById('roomName').value;
            const password = document.getElementById('roomPassword').value;
            
            fetch('/rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ room_name: roomName, password: password }),
                credentials: 'include' // 重要：包含cookie
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === '房间创建成功') {
                    alert('房间创建成功');
                    fetchRooms();
                } else {
                    alert(data.message);
                }
            });
        }
    </script>
</head>
<body>
    <div id="loginForm">
        <h2>Login</h2>
        <input type="text" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>
    
    <div id="chatForm" style="display:none">
        <h2>Rooms</h2>
        <div id="roomsContainer"></div>
        <h2>Create Room</h2>
        <input type="text" id="roomName" placeholder="Room Name">
        <input type="password" id="roomPassword" placeholder="Room Password (optional)">
        <button onclick="createRoom()">Create Room</button>
        <h2>Chat</h2>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Type a message">
        <button onclick="sendMessage()">Send</button>
    </div>
</body>
</html>
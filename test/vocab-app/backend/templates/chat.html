<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯æŒ‘æˆ˜èŠå¤©å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }
        .login-section, .chat-section, .challenge-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .login-section {
            width: 300px;
        }
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .challenge-section {
            width: 300px;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 200px;
            max-height: 400px;
            background-color: #fff;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #f0f0f0;
            word-break: break-word;
        }
        .message.system {
            background-color: #e3f2fd;
            font-style: italic;
            color: #1976d2;
        }
        .message.user {
            background-color: #e8f5e9;
            margin-left: 20px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="password"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .owner-controls {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
        .import-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: none; /* é»˜è®¤éšè— */
        }
        
        .import-form {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .import-btn {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .import-btn:hover {
            background-color: #45a049;
        }
        
        .import-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .import-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .import-success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        
        .import-error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
    </style>
</head>
<body>
    
    <div class="container">
        <!-- ç™»å½•éƒ¨åˆ† -->
        <div class="login-section" id="loginSection">
            <h2>ç™»å½•</h2>
            <div class="input-group">
                <input type="text" id="email" placeholder="é‚®ç®±">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="å¯†ç ">
            </div>
            <button onclick="login()">ç™»å½•</button>
        </div>

        <!-- ä¿®æ”¹å¯¼å…¥éƒ¨åˆ†çš„ä½ç½®ï¼Œæ”¾åœ¨ç™»å½•åŒºåŸŸä¹‹å -->
        <div class="import-section" id="importSection">
            <h3>å¯¼å…¥å•è¯</h3>
            <div class="import-form">
                <input type="file" id="csvFile" accept=".csv">
                <button class="import-btn" id="importBtn" onclick="importWords()">å¯¼å…¥CSV</button>
            </div>
            <div id="importMessage" class="import-message"></div>
        </div>

        <!-- èŠå¤©éƒ¨åˆ† -->
        <div class="chat-section hidden" id="chatSection">
            <h2>èŠå¤©å®¤</h2>
            <!-- åˆ›å»ºæˆ¿é—´ -->
            <div class="input-group">
                <input type="text" id="roomName" placeholder="æˆ¿é—´åç§°">
                <button onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
            </div>
            <!-- åŠ å…¥æˆ¿é—´ -->
            <div class="input-group">
                <input type="text" id="roomId" placeholder="æˆ¿é—´ID">
                <button onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            </div>
            <div class="messages" id="messages"></div>
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button onclick="sendMessage()">å‘é€</button>
            </div>
            <button onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
        </div>

        <!-- å•è¯æŒ‘æˆ˜éƒ¨åˆ† -->
        <div class="challenge-section hidden" id="challengeSection">
            <h2>å•è¯æŒ‘æˆ˜</h2>
            <div id="create-section" class="hidden">
                <h3>æŒ‘æˆ˜è®¾ç½®ï¼ˆä»…æˆ¿ä¸»å¯è§ï¼‰</h3>
                <div class="input-group">
                    <input type="number" id="num-words" placeholder="é»˜è®¤ 5 ä¸ªé¢˜ç›®" />
                    <button onclick="createChallenge()">åˆ›å»ºæŒ‘æˆ˜</button>
                </div>
            </div>
            
            <div id="challenge-container" class="hidden">
                <h3>æŒ‘æˆ˜è¿›è¡Œä¸­</h3>
                <p>å½“å‰å•è¯é‡Šä¹‰ï¼š<span id="word-meaning">ç­‰å¾…å¼€å§‹</span></p>
                <div class="input-group">
                    <input type="text" id="answer" placeholder="è¾“å…¥ä½ çš„ç­”æ¡ˆ">
                    <button onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
                </div>
                <p id="feedback" style="margin-top:10px;"></p>
            </div>
        </div>

    <script>
        let socket;
        let currentRoomId = null;
        let isRoomOwner = false;

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            });

            socket.on('disconnect', () => {
                console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                currentRoomId = null;
                isRoomOwner = false;
                updateUI();
                $('#messages').empty();
            });

            socket.on('system_message', (data) => {
                console.log('æ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯:', data);
                appendMessage(data.message, true);
            });

            socket.on('new_message', (data) => {
                console.log('æ”¶åˆ°æ–°æ¶ˆæ¯:', data);
                const currentUserId = sessionStorage.getItem('user_id');
                const isCurrentUser = data.user_id == currentUserId;
                console.log('å½“å‰ç”¨æˆ·ID:', currentUserId, 'æ¶ˆæ¯ç”¨æˆ·ID:', data.user_id, 'æ˜¯å¦å½“å‰ç”¨æˆ·:', isCurrentUser);
                
                // å¦‚æœä¸æ˜¯å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæ‰æ˜¾ç¤º
                /*if (!isCurrentUser) {
                    appendMessage(`${data.nickname}: ${data.content}`, false, false);
                }*/
               // ä¿®æ”¹è¿™é‡Œï¼šæ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯ï¼Œä½†åŒºåˆ†æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„
                appendMessage(`${data.nickname}: ${data.content}`, false, isCurrentUser);
            });

            socket.on('room_joined', (data) => {
                console.log('åŠ å…¥æˆ¿é—´æˆåŠŸ:', data);
                currentRoomId = data.room_id;
                isRoomOwner = data.is_owner;
                updateUI();
                appendMessage(`å·²åŠ å…¥æˆ¿é—´: ${data.room_name}`, true);
            });

            socket.on('answer_result', (data) => {
                appendMessage(`ç­”æ¡ˆ${data.correct ? 'æ­£ç¡®' : 'é”™è¯¯'}: ${data.message}`, true);
            });

            socket.on('room_left', (data) => {
                if (data.room_id === currentRoomId) {
                    currentRoomId = null;
                    isRoomOwner = false;
                    updateUI();
                    appendMessage('å·²ç¦»å¼€æˆ¿é—´', true);
                    $('#messages').empty();
                }
            });

            // æ·»åŠ æ–°çš„Socketäº‹ä»¶ç›‘å¬ï¼ˆæ”¾åœ¨initSocketå‡½æ•°ä¸­ï¼‰
            socket.on('reveal_word', (data) => {
                console.log('æ”¶åˆ°å•è¯:', data);
                $('#word-meaning').text(data.word_meaning);
                $('#answer').val('').prop('disabled', false);
                $('#feedback').text('');
            });

            socket.on('reveal_answer', (data) => {
                $('#feedback').text(`æ­£ç¡®ç­”æ¡ˆ: ${data.word}`);
                $('#answer').prop('disabled', true);
            });

            socket.on('challenge_end', () => {
                appendMessage("ğŸ‰ æŒ‘æˆ˜ç»“æŸï¼", true);
                $('#challenge-container').addClass('hidden');
            });
            socket.on('answer_feedback', (data) => {
                const isCurrentUser = data.user_id == sessionStorage.getItem('user_id');
                const nickname = sessionStorage.getItem('nickname');
                const feedback = `${nickname} :${data.mask}`;
                appendMessage(feedback, true, false, true);
                
            });
        }

        // ç™»å½•
        function login() {
            const email = $('#email').val();
            const password = $('#password').val();
            
            $.ajax({
                url: '/api/auth/login',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ email, password }),
                success: (response) => {
                    if (response.code === 200) {
                        // å­˜å‚¨ç”¨æˆ·IDåˆ°sessionStorage
                        sessionStorage.setItem('user_id', response.data.user_id);
                        sessionStorage.setItem('nickname', response.data.nickname);
                        
                        $('#loginSection').addClass('hidden');
                        $('#chatSection').removeClass('hidden');
                        $('#challengeSection').removeClass('hidden');
                        $('#importSection').show(); // æ˜¾ç¤ºå¯¼å…¥åŒºåŸŸ
                        initSocket();
                    } else {
                        alert(response.message);
                    }
                },
                error: () => {
                    alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            });
        }

        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            const roomName = $('#roomName').val();
            if (!roomName) {
                alert('è¯·è¾“å…¥æˆ¿é—´åç§°');
                return;
            }

            // ç¡®ä¿socketå·²è¿æ¥
            if (!socket || !socket.connected) {
                alert('è¯·ç­‰å¾…WebSocketè¿æ¥å°±ç»ª');
                return;
            }

            $.ajax({
                url: '/rooms',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ room_name: roomName }),
                success: (response) => {
                    if (response.code === 201) {
                        console.log('æˆ¿é—´åˆ›å»ºæˆåŠŸ:', response);
                        
                        //isRoomOwner = true;
                        currentRoomId = response.data.room_id;
                        isRoomOwner = response.data.is_owner;

                        sessionStorage.setItem('current_room_id', currentRoomId); // å¯é€‰ï¼šå­˜å‚¨åˆ° sessionStorage
                        sessionStorage.setItem('is_room_owner', isRoomOwner); // å¯é€‰ï¼šå­˜å‚¨åˆ° sessionStorage

                        updateUI();

                        // å…³é”®ä¿®æ”¹1: ç¡®ä¿æºå¸¦ç”¨æˆ·IDåŠ å…¥æˆ¿é—´
                        socket.emit('join_room', {
                            room_id: currentRoomId,
                            room_name: response.data.room_name,
                            user_id: sessionStorage.getItem('user_id') // å¿…é¡»ä¼ é€’ç”¨æˆ·ID
                        });

                        // å…³é”®ä¿®æ”¹2: ç­‰å¾…socketç¡®è®¤åå†æ›´æ–°UI
                        socket.once('room_joined', () => {
                            updateUI();
                            appendMessage(`æˆåŠŸåˆ›å»ºå¹¶åŠ å…¥æˆ¿é—´: ${response.data.room_name}`, true);
                        });

                    } else {
                        alert(response.message);
                    }
                },
                error: (xhr) => {
                    console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', xhr.responseText);
                    alert('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + (xhr.responseJSON?.message || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }
        
        // ç¦»å¼€æˆ¿é—´
        function leaveRoom() {
            if (!currentRoomId) {
                alert('æ‚¨å½“å‰ä¸åœ¨ä»»ä½•æˆ¿é—´ä¸­');
                return;
            }

            socket.emit('leave_room', {
                room_id: currentRoomId
            });
        }
        // å®šä¹‰joinRoomå‡½æ•°
        function joinRoom() {
            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                alert('è¯·è¾“å…¥æˆ¿é—´ID');
                return;
            }
            
            if (!socket || !socket.connected) {
                alert('è¯·ç­‰å¾…è¿æ¥å»ºç«‹');
                return;
            }
            
            const userId = sessionStorage.getItem('user_id');
            if (!userId) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            socket.emit('join_room', {
                room_id: roomId,
                user_id: userId
            });
            // ç›‘å¬ room_joined äº‹ä»¶
            socket.once('room_joined', (data) => {
                console.log('åŠ å…¥æˆ¿é—´æˆåŠŸ:', data);
                currentRoomId = data.room_id;
                isRoomOwner = data.is_owner; // ç¡®ä¿ä»æœåŠ¡å™¨è¿”å›çš„æ•°æ®ä¸­è·å–æˆ¿ä¸»çŠ¶æ€
                updateUI(); // æ›´æ–° UI
                appendMessage(`å·²åŠ å…¥æˆ¿é—´: ${data.room_name}`, true);
            });
        }
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!currentRoomId) {
                alert('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            const content = $('#messageInput').val();
            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            const currentUserId = sessionStorage.getItem('user_id');
            console.log('å‘é€æ¶ˆæ¯:', {
                room_id: currentRoomId,
                content: content,
                user_id: currentUserId,
                is_owner: isRoomOwner // æ˜¾å¼ä¼ é€’æˆ¿ä¸»çŠ¶æ€
            });

            socket.emit('message', {
                room_id: currentRoomId,
                content: content,
                user_id: currentUserId,
                is_owner: isRoomOwner // æ˜¾å¼ä¼ é€’æˆ¿ä¸»çŠ¶æ€
            });

            // ç«‹å³æ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯
            /*const currentNickname = sessionStorage.getItem('nickname');
            appendMessage(`${currentNickname}: ${content}`, false, true);*/

            // æ¸…ç©ºè¾“å…¥æ¡†
            $('#messageInput').val('');
        }

        

        // æ›´æ–° createChallenge å‡½æ•°
        function createChallenge() {
            if (!currentRoomId) {
                alert('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            const numWords = parseInt($('#num-words').val()) || 5;
            
            $.ajax({
                url: '/api/challenge/create',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    room_id: currentRoomId,
                    num_words: numWords
                }),
                success: (response) => {
                    if (response.code === 201) {
                        appendMessage("æŒ‘æˆ˜åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…å¼€å§‹...", true);
                    } else {
                        alert(response.message);
                    }
                },
                error: () => {
                    alert('åˆ›å»ºæŒ‘æˆ˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            });
        }


        // æ›´æ–° submitAnswer å‡½æ•°
        function submitAnswer() {
            if (!currentRoomId) {
                alert('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            const answer = $('#answer').val().trim();
            if (!answer) {
                alert('è¯·è¾“å…¥ç­”æ¡ˆ');
                return;
            }

            const userId = sessionStorage.getItem('user_id');
            socket.emit('submit_answer', {
                room_id: currentRoomId,
                user_id: userId,
                answer: answer
            });
        }
        // æ›´æ–° updateUI å‡½æ•°
        function updateUI() {
            console.log('æ›´æ–°UI,å½“å‰çŠ¶æ€:', {
                currentRoomId: !!currentRoomId,
                isRoomOwner: isRoomOwner
            });
            
            if (currentRoomId) {
                $('#create-section').toggleClass('hidden', !isRoomOwner);
                $('#challenge-container').removeClass('hidden');
                $('#challengeSection').removeClass('hidden');
                $('#importSection').show();
            } else {
                $('#challengeSection').addClass('hidden');
                $('#importSection').hide();
            }
        }


        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
        function appendMessage(message, isSystem = false, isCurrentUser = false) {
            console.log('æ·»åŠ æ¶ˆæ¯:', { message, isSystem, isCurrentUser });
            
            const messageDiv = $('<div>')
                .addClass('message')
                .text(message);
            
            if (isSystem) {
                messageDiv.addClass('system');
            } else if (isCurrentUser) {
                messageDiv.addClass('user');
            }
            
            $('#messages').append(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const messagesDiv = $('#messages');
            messagesDiv.scrollTop(messagesDiv.prop('scrollHeight'));
            
            // ç¡®ä¿æ¶ˆæ¯å¯è§
            messageDiv[0].scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        // ä¿®æ”¹å¯¼å…¥å•è¯çš„å‡½æ•°
        function importWords() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showImportMessage('è¯·é€‰æ‹©CSVæ–‡ä»¶', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const importBtn = document.getElementById('importBtn');
            importBtn.disabled = true;
            
            $.ajax({
                url: '/challenges/import',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    showImportMessage(response.message, 'success');
                    // å¯¼å…¥æˆåŠŸåé‡æ–°åŠ è½½å•è¯åˆ—è¡¨
                    if (isRoomOwner) {
                        loadWords();
                    }
                },
                error: function(xhr) {
                    const message = xhr.responseJSON ? xhr.responseJSON.message : 'å¯¼å…¥å¤±è´¥';
                    showImportMessage(message, 'error');
                },
                complete: function() {
                    importBtn.disabled = false;
                    fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                }
            });
        }
        
        function showImportMessage(message, type) {
            const messageDiv = document.getElementById('importMessage');
            messageDiv.textContent = message;
            messageDiv.className = `import-message import-${type}`;
            messageDiv.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—æ¶ˆæ¯
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // åˆå§‹åŒ–
        $(document).ready(() => {
            $('#messageInput').keypress((e) => {
                if (e.which === 13) {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
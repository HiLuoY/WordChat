<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯æŒ‘æˆ˜èŠå¤©å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }
        .login-section, .chat-section, .challenge-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .login-section {
            width: 300px;
        }
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .challenge-section {
            width: 300px;
        }
        .ranking-section {
        width: 300px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .ranking-board {
        margin-top: 15px;
    }

    .ranking-header {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        font-weight: bold;
    }

    .ranking-header span {
        flex: 1;
        text-align: center;
    }

    .ranking-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f5f5f5;
    }

    .ranking-item:nth-child(odd) {
        background-color: #f9f9f9;
    }

    .ranking-item span {
        flex: 1;
        text-align: center;
    }

    .my-ranking {
        margin-top: 15px;
        padding: 10px;
        background-color: #e3f2fd;
        border-radius: 4px;
        text-align: center;
    }
        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 200px;
            max-height: 400px;
            background-color: #fff;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #f0f0f0;
            word-break: break-word;
        }
        .message.system {
            background-color: #e3f2fd;
            font-style: italic;
            color: #1976d2;
        }
        .message.user {
            background-color: #e8f5e9;
            margin-left: 20px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="password"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .owner-controls {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
        
    
    </style>
</head>
<body>
    
    <div class="container">
        <!-- ç™»å½•éƒ¨åˆ† -->
        <div class="login-section" id="loginSection">
            <h2>ç™»å½•</h2>
            <div class="input-group">
                <input type="text" id="email" placeholder="é‚®ç®±">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="å¯†ç ">
            </div>
            <button onclick="login()">ç™»å½•</button>
        </div>

        <!-- ä¿®æ”¹å¯¼å…¥éƒ¨åˆ†çš„ä½ç½®ï¼Œæ”¾åœ¨ç™»å½•åŒºåŸŸä¹‹å -->
        <!--
        <div class="import-section" id="importSection">
            <h3>å¯¼å…¥å•è¯</h3>
            <div class="import-form">
                <input type="file" id="csvFile" accept=".csv">
                <button class="import-btn" id="importBtn" onclick="importWords()">å¯¼å…¥CSV</button>
            </div>
            <div id="importMessage" class="import-message"></div>
        </div>
    -->

        <!-- èŠå¤©éƒ¨åˆ† -->
        <div class="chat-section hidden" id="chatSection">
            <h2>èŠå¤©å®¤</h2>
            <!-- åˆ›å»ºæˆ¿é—´ -->
            <div class="input-group">
                <input type="text" id="roomName" placeholder="æˆ¿é—´åç§°">
                <button onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
            </div>
            <!-- åŠ å…¥æˆ¿é—´ -->
            <div class="input-group">
                <input type="text" id="roomId" placeholder="æˆ¿é—´ID">
                <button onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            </div>
            <div class="messages" id="messages"></div>
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button onclick="sendMessage()">å‘é€</button>
            </div>
            <button onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
        </div>

        <!-- å•è¯æŒ‘æˆ˜éƒ¨åˆ† -->
        <div class="challenge-section hidden" id="challengeSection">
            <h2>å•è¯æŒ‘æˆ˜</h2>
            <div id="create-section" class="hidden">
                <h3>æŒ‘æˆ˜è®¾ç½®ï¼ˆä»…æˆ¿ä¸»å¯è§ï¼‰</h3>
                <div class="input-group">
                    <input type="number" id="num-words" placeholder="é»˜è®¤ 5 ä¸ªé¢˜ç›®" />
                    <button onclick="createChallenge()">åˆ›å»ºæŒ‘æˆ˜</button>
                </div>
            </div>
            
            <div id="challenge-container" class="hidden">
                <h3>æŒ‘æˆ˜è¿›è¡Œä¸­</h3>
                <p>å½“å‰å•è¯é‡Šä¹‰ï¼š<span id="word-meaning">ç­‰å¾…å¼€å§‹</span></p>
                <div class="input-group">
                    <input type="text" id="answer" placeholder="è¾“å…¥ä½ çš„ç­”æ¡ˆ">
                    <button onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
                </div>
                <p id="feedback" style="margin-top:10px;"></p>
            </div>
        </div>

    <!-- åœ¨ç°æœ‰å®¹å™¨ä¸­æ·»åŠ æ’è¡Œæ¦œåŒºå— -->
    <div class="container">
        <!-- åŸæœ‰å…¶ä»–åŒºå—ä¿æŒä¸å˜... -->
        
        <!-- æ–°å¢æ’è¡Œæ¦œåŒºå— -->
        <div class="ranking-section hidden" id="rankingSection">
            <h2>å®æ—¶æ’è¡Œæ¦œ</h2>
            <div class="ranking-board">
                <div class="ranking-header">
                    <span>æ’å</span>
                    <span>ç©å®¶</span>
                    <span>åˆ†æ•°</span>
                    <span>æœ€åæ›´æ–°</span>
                </div>
                <div class="ranking-list" id="rankingList"></div>
            </div>
            <div class="my-ranking">
                æˆ‘çš„å½“å‰æ’å: <span id="myRank">-</span>
            </div>
        </div>
    </div>


    <script>
        let socket;
        let currentRoomId = null;
        let isRoomOwner = false;

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initSocket() {
            socket = io();
            
            socket.on('connect', () => {
            console.log('WebSocket è¿æ¥æˆåŠŸ');
            // è¿æ¥æˆåŠŸåé‡æ–°è¯·æ±‚æ’è¡Œæ¦œæ•°æ®
            if (currentRoomId) {
                socket.emit('request_leaderboard', { room_id: currentRoomId, limit: 10 });
                socket.emit('get_my_ranking', { room_id: currentRoomId, user_id: sessionStorage.getItem('user_id') });
            }
        });

            socket.on('disconnect', () => {
                console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                currentRoomId = null;
                isRoomOwner = false;
                updateUI();
                $('#messages').empty();
            });

            socket.on('system_message', (data) => {
                console.log('æ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯:', data);
                appendMessage(data.message, true);
            });

            socket.on('new_message', (data) => {
                console.log('æ”¶åˆ°æ–°æ¶ˆæ¯:', data);
                const currentUserId = sessionStorage.getItem('user_id');
                const isCurrentUser = data.user_id == currentUserId;
                console.log('å½“å‰ç”¨æˆ·ID:', currentUserId, 'æ¶ˆæ¯ç”¨æˆ·ID:', data.user_id, 'æ˜¯å¦å½“å‰ç”¨æˆ·:', isCurrentUser);
                
                // å¦‚æœä¸æ˜¯å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæ‰æ˜¾ç¤º
                /*if (!isCurrentUser) {
                    appendMessage(`${data.nickname}: ${data.content}`, false, false);
                }*/
               // ä¿®æ”¹è¿™é‡Œï¼šæ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯ï¼Œä½†åŒºåˆ†æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„
                appendMessage(`${data.nickname}: ${data.content}`, false, isCurrentUser);
            });

            socket.on('room_joined', (data) => {
                console.log('åŠ å…¥æˆ¿é—´æˆåŠŸ:', data);
                currentRoomId = data.room_id;
                isRoomOwner = data.is_owner;
                updateUI();
                appendMessage(`å·²åŠ å…¥æˆ¿é—´: ${data.room_name}`, true);

                // åŠ å…¥æ’è¡Œæ¦œæˆ¿é—´
                socket.emit('join_ranking_room', { room_id: data.room_id });
                
                
                // æ–°å¢ï¼šä¸»åŠ¨è¯·æ±‚æ’è¡Œæ¦œæ•°æ®
                socket.emit('request_leaderboard', { 
                    room_id: data.room_id,
                    limit: 10 
                });
                // è¯·æ±‚ä¸ªäººæ’å
                socket.emit('get_my_ranking', { 
                    room_id: data.room_id,
                    user_id: sessionStorage.getItem('user_id')
                });

                console.log('æˆ¿é—´æˆå‘˜æ•°æ®:', data);
                console.log('å½“å‰ç”¨æˆ·ID:', sessionStorage.getItem('user_id'));
            });
            // æ’è¡Œæ¦œæ›´æ–°äº‹ä»¶
            socket.on('leaderboard_update', (data) => {
                console.log('æ”¶åˆ°æ’è¡Œæ¦œæ›´æ–°äº‹ä»¶');
                console.log('æ’è¡Œæ¦œæ›´æ–°æ•°æ®:', data);
                // æ‰“å°å½“å‰æ—¶é—´ä»¥ä¾¿æ’æŸ¥æ—¶é—´å·®é—®é¢˜
                console.log('å½“å‰æ—¶é—´:', new Date().toISOString());
                updateRankingUI(data);
            });

            // ä¸ªäººæ’åå“åº”
            socket.on('user_ranking', (data) => {
                console.log('æ”¶åˆ°ä¸ªäººæ’åäº‹ä»¶');
                console.log('ä¸ªäººæ’åæ•°æ®:', data);
                // æ‰“å°å½“å‰æ—¶é—´ä»¥ä¾¿æ’æŸ¥æ—¶é—´å·®é—®é¢˜
                console.log('å½“å‰æ—¶é—´:', new Date().toISOString());
                $('#myRank').text(data.rank || 'æœªä¸Šæ¦œ');
            });
            
           // æ¥æ”¶ç­”æ¡ˆç»“æœ
            socket.on('answer_result', (data) => {
                console.log('æ”¶åˆ°ç­”æ¡ˆç»“æœ:', data);
                appendMessage(`ç­”æ¡ˆ${data.correct ? 'æ­£ç¡®' : 'é”™è¯¯'}: ${data.message}`, true);

                // å¦‚æœç­”æ¡ˆæ­£ç¡®ï¼Œæäº¤åˆ†æ•°
                if (data.correct) {
                    // å‡è®¾æ¯æ¬¡æ­£ç¡®å›ç­”+10åˆ†
                    socket.emit('submit_score', {
                        room_id: currentRoomId,
                        delta: 10
                    });
                }
            });
            socket.on('room_left', (data) => {
                if (data.room_id === currentRoomId) {
                    currentRoomId = null;
                    isRoomOwner = false;
                    updateUI();
                    appendMessage('å·²ç¦»å¼€æˆ¿é—´', true);
                    $('#messages').empty();
                    //é‡ç½®æ’è¡Œæ¦œ
                    $('#rankingList').empty();
                    $('#myRank').text('-');
                }
            });

            // æ·»åŠ æ–°çš„Socketäº‹ä»¶ç›‘å¬ï¼ˆæ”¾åœ¨initSocketå‡½æ•°ä¸­ï¼‰
            socket.on('reveal_word', (data) => {
                console.log('æ”¶åˆ°å•è¯:', data);
                $('#word-meaning').text(data.word_meaning);
                $('#answer').val('').prop('disabled', false);
                $('#feedback').text('');
                $('#challenge-container').removeClass('hidden');
                $('#answer').prop('disabled', false);
            });

            socket.on('reveal_answer', (data) => {
                $('#feedback').text(`æ­£ç¡®ç­”æ¡ˆ: ${data.word}`);
                $('#answer').prop('disabled', true);
            });

            socket.on('challenge_end', () => {
                appendMessage("ğŸ‰ æŒ‘æˆ˜ç»“æŸï¼æˆ¿ä¸»å¯ä»¥å¼€å§‹æ–°ä¸€è½®æŒ‘æˆ˜", true);
                // ä»…é‡ç½®å†…å®¹ä¸éšè—å®¹å™¨
                $('#word-meaning').text('ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ–°ä¸€è½®æŒ‘æˆ˜...');
                $('#answer').val('').prop('disabled', true);
                $('#feedback').text('');
            });
            socket.on('answer_feedback', (data) => {
                const isCurrentUser = data.user_id == sessionStorage.getItem('user_id');
                const nickname = sessionStorage.getItem('nickname');
                const feedback = `${nickname} :${data.mask}`;
                appendMessage(feedback, true, false, true);
                
            });
        }
        const API_BASE_URL = window.location.origin; // è‡ªåŠ¨è·å–å½“å‰åŸŸå
        // ç™»å½•
        function login() {
            const email = $('#email').val();
            const password = $('#password').val();
            
            $.ajax({
                url: '/api/auth/login',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ email, password }),
                success: (response) => {
                    if (response.code === 200) {
                        // å­˜å‚¨ç”¨æˆ·IDåˆ°sessionStorage
                        sessionStorage.setItem('user_id', response.data.user_id);
                        sessionStorage.setItem('nickname', response.data.nickname);
                        
                        $('#loginSection').addClass('hidden');
                        $('#chatSection').removeClass('hidden');
                        $('#challengeSection').removeClass('hidden');
                        //$('#importSection').show(); // æ˜¾ç¤ºå¯¼å…¥åŒºåŸŸ
                        initSocket();
                    } else {
                        alert(response.message);
                    }
                },
                error: () => {
                    alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            });
        }

        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            const roomName = $('#roomName').val();
            if (!roomName) {
                alert('è¯·è¾“å…¥æˆ¿é—´åç§°');
                return;
            }

            // ç¡®ä¿socketå·²è¿æ¥
            if (!socket || !socket.connected) {
                alert('è¯·ç­‰å¾…WebSocketè¿æ¥å°±ç»ª');
                return;
            }

            $.ajax({
                url: '/api/rooms',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ room_name: roomName }),
                success: (response) => {
                    if (response.code === 201) {
                        console.log('æˆ¿é—´åˆ›å»ºæˆåŠŸ:', response);
                        
                        //isRoomOwner = true;
                        currentRoomId = response.data.room_id;
                        isRoomOwner = response.data.is_owner;

                        sessionStorage.setItem('current_room_id', currentRoomId); // å¯é€‰ï¼šå­˜å‚¨åˆ° sessionStorage
                        sessionStorage.setItem('is_room_owner', isRoomOwner); // å¯é€‰ï¼šå­˜å‚¨åˆ° sessionStorage

                        updateUI();

                        // å…³é”®ä¿®æ”¹1: ç¡®ä¿æºå¸¦ç”¨æˆ·IDåŠ å…¥æˆ¿é—´
                        socket.emit('join_room', {
                            room_id: currentRoomId,
                            room_name: response.data.room_name,
                            user_id: sessionStorage.getItem('user_id') // å¿…é¡»ä¼ é€’ç”¨æˆ·ID
                        });

                        // å…³é”®ä¿®æ”¹2: ç­‰å¾…socketç¡®è®¤åå†æ›´æ–°UI
                        socket.once('room_joined', () => {
                            updateUI();
                            appendMessage(`æˆåŠŸåˆ›å»ºå¹¶åŠ å…¥æˆ¿é—´: ${response.data.room_name}`, true);
                        });

                    } else {
                        alert(response.message);
                    }
                },
                error: (xhr) => {
                    console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', xhr.responseText);
                    alert('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + (xhr.responseJSON?.message || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }
        
        // ç¦»å¼€æˆ¿é—´
        function leaveRoom() {
            if (!currentRoomId) {
                alert('æ‚¨å½“å‰ä¸åœ¨ä»»ä½•æˆ¿é—´ä¸­');
                return;
            }

            socket.emit('leave_room', {
                room_id: currentRoomId
            });
            $('#challenge-container').addClass('hidden');
            $('#word-meaning').text('ç­‰å¾…å¼€å§‹');
        }
        // å®šä¹‰joinRoomå‡½æ•°
        function joinRoom() {
            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                alert('è¯·è¾“å…¥æˆ¿é—´ID');
                return;
            }
            
            if (!socket || !socket.connected) {
                alert('è¯·ç­‰å¾…è¿æ¥å»ºç«‹');
                return;
            }
            
            const userId = sessionStorage.getItem('user_id');
            if (!userId) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            socket.emit('join_room', {
                room_id: roomId,
                user_id: userId
            });
            // ç›‘å¬ room_joined äº‹ä»¶
            socket.once('room_joined', (data) => {
                console.log('åŠ å…¥æˆ¿é—´æˆåŠŸ:', data);
                currentRoomId = data.room_id;
                isRoomOwner = data.is_owner; // ç¡®ä¿ä»æœåŠ¡å™¨è¿”å›çš„æ•°æ®ä¸­è·å–æˆ¿ä¸»çŠ¶æ€
                updateUI(); // æ›´æ–° UI
                
                appendMessage(`å·²åŠ å…¥æˆ¿é—´: ${data.room_name}`, true);
                // ä¸»åŠ¨è¯·æ±‚æ’è¡Œæ¦œæ•°æ®
                console.log('å‘é€è¯·æ±‚ï¼šè¯·æ±‚æ’è¡Œæ¦œæ•°æ®ï¼Œæˆ¿é—´ID:', currentRoomId);
                socket.emit('request_leaderboard', { room_id: currentRoomId, limit: 10 });

                // ä¸»åŠ¨è¯·æ±‚ä¸ªäººæ’å
                const userId = sessionStorage.getItem('user_id');
                console.log('å‘é€è¯·æ±‚ï¼šè¯·æ±‚ä¸ªäººæ’åï¼Œç”¨æˆ·ID:', userId, 'æˆ¿é—´ID:', currentRoomId);
                socket.emit('get_my_ranking', { room_id: currentRoomId, user_id: sessionStorage.getItem('user_id') });
                        });
        }
        // æ’è¡Œæ¦œæ›´æ–°äº‹ä»¶
        socket.on('leaderboard_update', (data) => {
            console.log('æ”¶åˆ°æ’è¡Œæ¦œæ›´æ–°äº‹ä»¶');
            console.log('æ’è¡Œæ¦œæ›´æ–°æ•°æ®:', data);
            // æ‰“å°å½“å‰æ—¶é—´ä»¥ä¾¿æ’æŸ¥æ—¶é—´å·®é—®é¢˜
            console.log('å½“å‰æ—¶é—´:', new Date().toISOString());
            updateRankingUI(data);
        });

        // ä¸ªäººæ’åå“åº”
        socket.on('user_ranking', (data) => {
            console.log('æ”¶åˆ°ä¸ªäººæ’åäº‹ä»¶');
            console.log('ä¸ªäººæ’åæ•°æ®:', data);
            // æ‰“å°å½“å‰æ—¶é—´ä»¥ä¾¿æ’æŸ¥æ—¶é—´å·®é—®é¢˜
            console.log('å½“å‰æ—¶é—´:', new Date().toISOString());
            $('#myRank').text(data.rank || 'æœªä¸Šæ¦œ');
        });

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!currentRoomId) {
                alert('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            const content = $('#messageInput').val();
            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            const currentUserId = sessionStorage.getItem('user_id');
            console.log('å‘é€æ¶ˆæ¯:', {
                room_id: currentRoomId,
                content: content,
                user_sid: currentUserId,
                is_owner: isRoomOwner // æ˜¾å¼ä¼ é€’æˆ¿ä¸»çŠ¶æ€
            });

            socket.emit('message', {
                room_id: currentRoomId,
                content: content,
                user_id: currentUserId,
                is_owner: isRoomOwner // æ˜¾å¼ä¼ é€’æˆ¿ä¸»çŠ¶æ€
            });

            // ç«‹å³æ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯
            /*const currentNickname = sessionStorage.getItem('nickname');
            appendMessage(`${currentNickname}: ${content}`, false, true);*/

            // æ¸…ç©ºè¾“å…¥æ¡†
            $('#messageInput').val('');
        }

        

        // æ›´æ–° createChallenge å‡½æ•°
        function createChallenge() {
            if (!currentRoomId) {
                alert('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            const numWords = parseInt($('#num-words').val()) || 5;
            // æ–°å¢ï¼šé‡ç½®æŒ‘æˆ˜ç•Œé¢
            $('#challenge-container').removeClass('hidden');
            $('#word-meaning').text('æ­£åœ¨å‡†å¤‡é¢˜ç›®...');
            $('#answer').val('').prop('disabled', false);
            $('#feedback').text('');
            
            $.ajax({
                url: '/api/challenge/create',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    room_id: currentRoomId,
                    num_words: numWords
                }),
                success: (response) => {
                    if (response.code === 201) {
                        appendMessage("æŒ‘æˆ˜åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…å¼€å§‹...", true);
                        // ç¡®ä¿ç•Œé¢å¯ç”¨çŠ¶æ€
                        $('#answer').prop('disabled', false);
                        $('#feedback').text('');
                    } else {
                        alert(response.message);
                    }
                },
                error: () => {
                    alert('åˆ›å»ºæŒ‘æˆ˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            });
        }


     // æäº¤ç­”æ¡ˆ
    function submitAnswer() {
        if (!currentRoomId) {
            alert('è¯·å…ˆåŠ å…¥æˆ¿é—´');
            return;
        }

        const answer = $('#answer').val().trim();
        if (!answer) {
            alert('è¯·è¾“å…¥ç­”æ¡ˆ');
            return;
        }

        const userId = sessionStorage.getItem('user_id');
        if (!userId) {
            alert('ç”¨æˆ·IDæœªæ­£ç¡®å­˜å‚¨ï¼Œè¯·é‡æ–°ç™»å½•');
            return;
        }

        console.log('æäº¤ç­”æ¡ˆ:', { room_id: currentRoomId, user_id: userId, answer: answer });
        socket.emit('submit_answer', {
            room_id: currentRoomId,
            user_id: userId,
            answer: answer
        });

        // æ¸…ç©ºè¾“å…¥æ¡†
        $('#answer').val('').prop('disabled', true);

        // åœ¨ answer_result äº‹ä»¶å¤„ç†ä¸­æ·»åŠ 
        socket.on('answer_result', (data) => {
            if (data.correct) {
                // å¢åŠ å»¶è¿Ÿç¡®ä¿æ•°æ®åŒæ­¥
                setTimeout(() => {
                    socket.emit('request_leaderboard', { 
                        room_id: currentRoomId,
                        limit: 10 
                    });
                }, 1000);
            }
        });
        
    }

        // æ›´æ–° updateUI å‡½æ•°
        function updateUI() {
            console.log('æ›´æ–°UI,å½“å‰çŠ¶æ€:', {
                currentRoomId: !!currentRoomId,
                isRoomOwner: isRoomOwner
            });
            
            
            if (currentRoomId) {
                $('#create-section').toggleClass('hidden', !isRoomOwner);
                $('#challenge-container').removeClass('hidden');
                $('#challengeSection').removeClass('hidden');
                $('#importSection').show();
            } else {
                $('#challengeSection').addClass('hidden');
                //$('#importSection').hide();
            }
            $('#rankingSection').toggleClass('hidden', !currentRoomId);
        }
        
        function updateRankingUI(rankingData) {
            const container = $('#rankingList').empty();
            
            // å¦‚æœæ²¡æœ‰æ’è¡Œæ¦œæ•°æ®ï¼Œåˆå§‹åŒ–æ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„æ•°æ®
            if (!rankingData || rankingData.length === 0) {
                const userId = sessionStorage.getItem('user_id');
                const nickname = sessionStorage.getItem('nickname') || 'åŒ¿åç”¨æˆ·';
                
                rankingData = [
                    { 
                        user_id: userId, // ç¡®ä¿åŒ…å«ç”¨æˆ·ID
                        nickname: nickname, 
                        score: 0, 
                        updated_at: new Date() 
                    }
                ];
            }
            
            // è·å–å½“å‰ç”¨æˆ·çš„ID
            const currentUserId = sessionStorage.getItem('user_id');
            
            rankingData.forEach((item, index) => {
                const entry = $('<div>').addClass('ranking-item');
                entry.append(
                    $('<span>').text(index + 1),
                    $('<span>').text(item.nickname || 'åŒ¿åç”¨æˆ·'),
                    $('<span>').text(item.score || 0),
                    $('<span>').text(moment(item.updated_at).format('HH:mm') || '-')
                );
                
                // ä½¿ç”¨ç”¨æˆ·IDè¿›è¡Œé«˜äº®åˆ¤æ–­
                if (item.user_id === currentUserId) {
                    entry.css('background-color', '#e3f2fd');
                    entry.css('font-weight', 'bold');
                }
                
                container.append(entry);
            });
        }




        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
        function appendMessage(message, isSystem = false, isCurrentUser = false) {
            console.log('æ·»åŠ æ¶ˆæ¯:', { message, isSystem, isCurrentUser });
            
            const messageDiv = $('<div>')
                .addClass('message')
                .text(message);
            
            if (isSystem) {
                messageDiv.addClass('system');
            } else if (isCurrentUser) {
                messageDiv.addClass('user');
            }
            
            $('#messages').append(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const messagesDiv = $('#messages');
            messagesDiv.scrollTop(messagesDiv.prop('scrollHeight'));
            
            // ç¡®ä¿æ¶ˆæ¯å¯è§
            messageDiv[0].scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function showImportMessage(message, type) {
            const messageDiv = document.getElementById('importMessage');
            messageDiv.textContent = message;
            messageDiv.className = `import-message import-${type}`;
            messageDiv.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—æ¶ˆæ¯
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // åˆå§‹åŒ–
        $(document).ready(() => {
            $('#messageInput').keypress((e) => {
                if (e.which === 13) {
                    sendMessage();
                }
            });
        });
    </script>

    
</body>
</html>
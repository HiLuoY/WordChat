<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å•è¯æŒ‘æˆ˜æ¸¸æˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.6.0/dist/socket.io.min.js"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        .button { padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        .button:disabled { background: #aaa; }
        .hidden { display: none; }
        input { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ¯ å•è¯æŒ‘æˆ˜æ¸¸æˆ</h1>

    <div>
        <label>æˆ¿é—´ID:</label>
        <input type="text" id="room-id">
        <label>ç”¨æˆ·ID:</label>
        <input type="text" id="user-id">
        <button class="button" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
    </div>

    <div id="create-section" class="hidden">
        <h3>æŒ‘æˆ˜è®¾ç½®ï¼ˆä»…æˆ¿ä¸»å¯è§ï¼‰</h3>
        <input type="number" id="num-words" placeholder="é»˜è®¤ 5 ä¸ªé¢˜ç›®" />
        <button class="button" onclick="createChallenge()">åˆ›å»ºæŒ‘æˆ˜</button>
    </div>

    <div id="challenge-container" class="hidden">
        <h2>æŒ‘æˆ˜ä¸­...</h2>
        <p>å½“å‰å•è¯ï¼š<span id="word-display">ç­‰å¾…å¼€å§‹</span></p>
        <input type="text" id="answer" placeholder="è¾“å…¥ä½ çš„ç­”æ¡ˆ">
        <button class="button" onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
        <p id="feedback"></p>
    </div>

    <script>
        let socket;
        let roomId, userId;
        let isOwner = false;

        function joinRoom() {
            roomId = document.getElementById('room-id').value.trim();
            userId = document.getElementById('user-id').value.trim();
            if (!roomId || !userId) return alert("æˆ¿é—´ID å’Œ ç”¨æˆ·ID ä¸èƒ½ä¸ºç©º");

            socket = io();
            // å…ˆç›‘å¬è¿æ¥æˆåŠŸ
            socket.on('connect', () => {
                console.log('Connected, now joining room...');
                socket.emit('join', { room_id: roomId, user_id: userId });
            });

            
            // å‡è®¾åç«¯å“åº” room_joined äº‹ä»¶
            socket.on('room_joined', (data) => {
                console.log('æˆ¿é—´åŠ å…¥æˆåŠŸ:', data);
                isOwner = data.is_owner;
                if (isOwner) {
                    document.getElementById("create-section").classList.remove("hidden");
                }
                document.getElementById("challenge-container").classList.remove("hidden");
            });

            socket.on('system_message', (msg) => {
                alert(msg.message || 'ç³»ç»Ÿæç¤º');
            });

            socket.on('next_word', (data) => {
                document.getElementById("word-display").textContent = "è¯·æ‹¼å†™æ­¤å•è¯...";
                document.getElementById("feedback").textContent = "";
                document.getElementById("answer").value = "";
                document.getElementById("answer").disabled = false;
            });

            socket.on('reveal_word', (data) => {
                document.getElementById("word-display").textContent = `${data.word}ï¼ˆ${data.meaning}ï¼‰`;
            });

            socket.on('answer_feedback', (data) => {
                document.getElementById("feedback").textContent = data.correct ? "âœ… æ­£ç¡®" : `âŒ é”™è¯¯ï¼ä½ è¾“å…¥äº† ${data.mask}`;
                document.getElementById("answer").disabled = true;
            });

            socket.on('challenge_end', () => {
                alert("ğŸ‰ æŒ‘æˆ˜ç»“æŸï¼");
            });
        }

        function createChallenge() {
            const numWords = parseInt(document.getElementById("num-words").value) || 5;
            fetch('/api/challenge/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    room_id: roomId,
                    owner_id: userId,
                    num_words: numWords
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.challenge_id) {
                    // å¹¿æ’­ç¬¬ä¸€é“é¢˜
                    socket.emit('next_word', { room_id: roomId });
                    socket.emit('start_timer', { room_id: roomId });
                } else {
                    alert(data.error || "åˆ›å»ºæŒ‘æˆ˜å¤±è´¥");
                }
            });
        }

        function submitAnswer() {
            const answer = document.getElementById("answer").value.trim();
            if (answer) {
                socket.emit('submit_answer', {
                    room_id: roomId,
                    user_id: userId,
                    answer: answer
                });
            }
        }
    </script>
</body>
</html>
